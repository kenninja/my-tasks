<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --mail-color: #3b82f6;
      --slack-color: #e11d48;
      --other-color: #8b5cf6;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }
    .app { max-width: 720px; margin: 0 auto; padding: 16px; }

    .header { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; margin-bottom: 8px; }
    .header h1 { font-size: 1.5rem; font-weight: 700; }
    .header-actions { display: flex; gap: 8px; }
    .btn-icon {
      background: var(--card); border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 12px; cursor: pointer; font-size: 0.8rem; color: var(--text-light); transition: all 0.15s;
    }
    .btn-icon:hover { background: var(--primary); color: white; border-color: var(--primary); }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ */
    .alert-banner {
      display: none; background: linear-gradient(135deg, #fef2f2, #fff7ed);
      border: 1px solid #fecaca; border-radius: var(--radius); padding: 14px 18px;
      margin-bottom: 12px; cursor: pointer; transition: all 0.15s;
    }
    .alert-banner.show { display: block; }
    .alert-banner:hover { box-shadow: var(--shadow); }
    .alert-banner-title { font-weight: 700; font-size: 0.9rem; color: var(--danger); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .alert-banner-list { list-style: none; display: flex; flex-direction: column; gap: 4px; }
    .alert-banner-list li { font-size: 0.82rem; color: #92400e; padding: 2px 0; display: flex; align-items: center; gap: 6px; }
    .alert-badge { display: inline-block; background: var(--danger); color: white; font-size: 0.7rem; font-weight: 700; padding: 1px 7px; border-radius: 10px; white-space: nowrap; }
    .alert-badge.warning { background: var(--warning); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .alert-banner.has-overdue { animation: pulse 2s ease-in-out infinite; }

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .input-section {
      background: var(--card); border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid var(--border);
    }
    .input-main { display: flex; gap: 8px; margin-bottom: 12px; }
    .input-main input[type="text"] {
      flex: 1; padding: 12px 16px; border: 2px solid var(--border);
      border-radius: 8px; font-size: 1rem; outline: none; transition: border-color 0.15s;
    }
    .input-main input[type="text"]:focus { border-color: var(--primary); }
    .btn-add {
      background: var(--primary); color: white; border: none; border-radius: 8px;
      padding: 12px 24px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.15s; white-space: nowrap;
    }
    .btn-add:hover { background: var(--primary-light); }
    .input-options { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .option-group { display: flex; align-items: center; gap: 6px; }
    .option-group label { font-size: 0.85rem; color: var(--text-light); font-weight: 500; }
    .source-buttons { display: flex; gap: 4px; }
    .source-btn {
      padding: 4px 12px; border: 1.5px solid var(--border); border-radius: 20px;
      background: white; font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
    }
    .source-btn.active[data-source="mail"] { background: var(--mail-color); color: white; border-color: var(--mail-color); }
    .source-btn.active[data-source="slack"] { background: var(--slack-color); color: white; border-color: var(--slack-color); }
    .source-btn.active[data-source="other"] { background: var(--other-color); color: white; border-color: var(--other-color); }
    .input-options input[type="date"], .input-options input[type="time"] {
      padding: 4px 8px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 0.85rem; outline: none;
    }
    .input-options select {
      padding: 4px 8px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 0.85rem; outline: none; background: white;
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ */
    .filter-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; align-items: center; }
    .filter-bar select {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 0.85rem; background: var(--card); outline: none; cursor: pointer;
    }
    .task-count { margin-left: auto; font-size: 0.85rem; color: var(--text-light); }

    /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
    .task-list { display: flex; flex-direction: column; gap: 8px; }

    .task-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px; display: flex; align-items: flex-start; gap: 12px;
      box-shadow: var(--shadow); transition: all 0.15s; animation: slideIn 0.2s ease-out;
      user-select: none;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .task-card:hover { box-shadow: var(--shadow-lg); }
    .task-card.completed { opacity: 0.55; }
    .task-card.completed .task-title { text-decoration: line-through; }
    .task-card.overdue { border-left: 4px solid var(--danger); }
    .task-card.due-today { border-left: 4px solid var(--warning); }
    .task-card.due-soon { border-left: 4px solid #fb923c; }
    .task-card.due-minutes { border-left: 4px solid var(--danger); }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
    .drag-handle {
      cursor: grab; color: var(--border); font-size: 1.1rem; padding: 0 4px;
      display: flex; align-items: center; flex-shrink: 0; margin-top: 2px;
      transition: color 0.15s;
    }
    .drag-handle:hover { color: var(--text-light); }
    .drag-handle:active { cursor: grabbing; }
    .task-card.dragging { opacity: 0.4; transform: scale(0.98); }
    .task-card.drag-over { border-top: 3px solid var(--primary); margin-top: -3px; }

    .task-checkbox {
      width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 6px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; margin-top: 2px; transition: all 0.15s;
    }
    .task-checkbox:hover { border-color: var(--primary); }
    .task-checkbox.checked { background: var(--success); border-color: var(--success); }
    .task-checkbox.checked::after { content: 'âœ“'; color: white; font-size: 14px; font-weight: bold; }

    .task-body { flex: 1; min-width: 0; cursor: pointer; }
    .task-body:hover .task-title { color: var(--primary); }
    .task-title { font-size: 0.95rem; font-weight: 500; margin-bottom: 6px; word-break: break-word; transition: color 0.15s; }
    .task-meta { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }

    .tag { padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .tag-mail { background: #dbeafe; color: var(--mail-color); }
    .tag-slack { background: #fce7f3; color: var(--slack-color); }
    .tag-other { background: #ede9fe; color: var(--other-color); }
    .tag-repeat { background: #ecfdf5; color: #059669; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .tag-alert-time { background: #fef3c7; color: #b45309; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .tag-deadline { font-size: 0.75rem; color: var(--text-light); }
    .tag-deadline.overdue { color: var(--danger); font-weight: 600; }
    .tag-deadline.due-today { color: var(--warning); font-weight: 600; }
    .tag-deadline.due-soon { color: #ea580c; font-weight: 600; }
    .tag-deadline.due-minutes { color: var(--danger); font-weight: 600; }
    .tag-priority { font-size: 0.75rem; font-weight: 600; }
    .tag-priority.high { color: var(--danger); }
    .tag-priority.medium { color: var(--warning); }
    .tag-priority.low { color: var(--success); }

    .task-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .btn-task-action {
      background: none; border: none; color: var(--text-light);
      cursor: pointer; padding: 4px 8px; border-radius: 6px;
      font-size: 0.85rem; opacity: 0; transition: all 0.15s;
    }
    .task-card:hover .btn-task-action { opacity: 1; }
    .btn-task-action:hover { background: #f1f5f9; color: var(--primary); }
    .btn-task-action.delete:hover { background: #fee2e2; color: var(--danger); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.4);
      z-index: 100; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--card); border-radius: var(--radius); padding: 24px;
      max-width: 460px; width: 90%; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto;
    }
    .modal h3 { margin-bottom: 16px; }
    .modal p { margin-bottom: 12px; font-size: 0.9rem; color: var(--text-light); }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
    .btn-modal {
      padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--card); cursor: pointer; font-size: 0.9rem;
    }
    .btn-modal.primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-modal.danger { background: var(--danger); color: white; border-color: var(--danger); }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .edit-form { display: flex; flex-direction: column; gap: 14px; }
    .edit-field { display: flex; flex-direction: column; gap: 4px; }
    .edit-field label { font-size: 0.85rem; color: var(--text-light); font-weight: 600; }
    .edit-field input, .edit-field select {
      padding: 10px 12px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 0.9rem; outline: none; background: white;
    }
    .edit-field input:focus, .edit-field select:focus { border-color: var(--primary); }
    .edit-field .source-buttons { margin-top: 2px; }
    .edit-row { display: flex; gap: 12px; }
    .edit-row .edit-field { flex: 1; }

    /* é€šçŸ¥ãƒãƒ¼ */
    .notification-bar {
      display: none; background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px;
      padding: 10px 16px; margin-bottom: 12px; font-size: 0.85rem; color: #92400e;
      cursor: pointer; align-items: center; gap: 8px;
    }
    .notification-bar.show { display: flex; }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
    .toast {
      background: var(--card); border: 1px solid var(--border); border-left: 4px solid var(--danger);
      border-radius: 8px; padding: 12px 16px; box-shadow: var(--shadow-lg);
      min-width: 280px; max-width: 380px; animation: toastIn 0.3s ease-out; cursor: pointer;
    }
    .toast.warning { border-left-color: var(--warning); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(60px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(60px); } }
    .toast-title { font-weight: 700; font-size: 0.85rem; margin-bottom: 4px; }
    .toast-body { font-size: 0.8rem; color: var(--text-light); }

    @media (max-width: 600px) {
      .app { padding: 8px; }
      .header h1 { font-size: 1.2rem; }
      .input-section { padding: 16px; }
      .input-main { flex-direction: column; }
      .btn-add { width: 100%; padding: 14px; }
      .input-options { flex-direction: column; align-items: flex-start; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .filter-bar select { width: 100%; }
      .task-count { margin-left: 0; text-align: center; }
      .btn-task-action { opacity: 1; }
      .task-card { padding: 14px; }
      .toast { min-width: unset; max-width: calc(100vw - 32px); }
      .edit-row { flex-direction: column; gap: 14px; }
      .drag-handle { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>ã‚¿ã‚¹ã‚¯ç®¡ç†</h1>
      <div class="header-actions">
        <button class="btn-icon" onclick="exportTasks()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn-icon" onclick="showImportModal()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div class="alert-banner" id="alertBanner" onclick="scrollToUrgent()"></div>
    <div class="notification-bar" id="notificationBar" onclick="requestNotification()">
      ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯
    </div>

    <div class="input-section">
      <div class="input-main">
        <input type="text" id="taskInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›... (Enter ã§è¿½åŠ )" autocomplete="off">
        <button class="btn-add" onclick="addTask()">è¿½åŠ </button>
      </div>
      <div class="input-options">
        <div class="option-group">
          <label>ã‚½ãƒ¼ã‚¹:</label>
          <div class="source-buttons">
            <button class="source-btn active" data-source="mail" onclick="setSource('mail')">ãƒ¡ãƒ¼ãƒ«</button>
            <button class="source-btn" data-source="slack" onclick="setSource('slack')">Slack</button>
            <button class="source-btn" data-source="other" onclick="setSource('other')">ãã®ä»–</button>
          </div>
        </div>
        <div class="option-group">
          <label>æœŸé™:</label>
          <input type="date" id="deadlineInput">
          <input type="time" id="deadlineTimeInput">
        </div>
        <div class="option-group">
          <label>å„ªå…ˆåº¦:</label>
          <select id="priorityInput">
            <option value="medium">ä¸­</option>
            <option value="high">é«˜</option>
            <option value="low">ä½</option>
          </select>
        </div>
        <div class="option-group">
          <label>ç¹°ã‚Šè¿”ã—:</label>
          <select id="repeatInput">
            <option value="none">ãªã—</option>
            <option value="daily">æ¯æ—¥</option>
            <option value="weekly">æ¯é€±</option>
            <option value="biweekly">éš”é€±</option>
            <option value="monthly">æ¯æœˆ</option>
          </select>
        </div>
        <div class="option-group">
          <label>ã‚¢ãƒ©ãƒ¼ãƒˆ:</label>
          <select id="alertInput">
            <option value="none">ãªã—</option>
            <option value="1min">1åˆ†å‰</option>
            <option value="5min">5åˆ†å‰</option>
            <option value="same-day">å½“æ—¥</option>
            <option value="1day">1æ—¥å‰</option>
            <option value="3days">3æ—¥å‰</option>
            <option value="1week">1é€±é–“å‰</option>
          </select>
        </div>
      </div>
    </div>

    <div class="filter-bar">
      <select id="filterSource" onchange="renderTasks()">
        <option value="all">ã™ã¹ã¦ã®ã‚½ãƒ¼ã‚¹</option>
        <option value="mail">ãƒ¡ãƒ¼ãƒ«</option>
        <option value="slack">Slack</option>
        <option value="other">ãã®ä»–</option>
      </select>
      <select id="filterStatus" onchange="renderTasks()">
        <option value="active">æœªå®Œäº†</option>
        <option value="all">ã™ã¹ã¦</option>
        <option value="completed">å®Œäº†æ¸ˆã¿</option>
      </select>
      <select id="sortBy" onchange="renderTasks()">
        <option value="manual">æ‰‹å‹•ä¸¦ã³æ›¿ãˆ</option>
        <option value="created">ä½œæˆæ—¥é †</option>
        <option value="deadline">æœŸé™é †</option>
        <option value="priority">å„ªå…ˆåº¦é †</option>
      </select>
      <span class="task-count" id="taskCount"></span>
    </div>

    <div class="task-list" id="taskList"></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <h3>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</p>
      <input type="file" id="importFile" accept=".json">
      <div class="modal-actions">
        <button class="btn-modal" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-modal primary" onclick="importTasks()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</h3>
      <div class="edit-form">
        <div class="edit-field">
          <label>ã‚¿ã‚¹ã‚¯å</label>
          <input type="text" id="editTitle">
        </div>
        <div class="edit-field">
          <label>ã‚½ãƒ¼ã‚¹</label>
          <div class="source-buttons" id="editSourceButtons">
            <button class="source-btn" data-source="mail" onclick="setEditSource('mail')">ãƒ¡ãƒ¼ãƒ«</button>
            <button class="source-btn" data-source="slack" onclick="setEditSource('slack')">Slack</button>
            <button class="source-btn" data-source="other" onclick="setEditSource('other')">ãã®ä»–</button>
          </div>
        </div>
        <div class="edit-row">
          <div class="edit-field">
            <label>æœŸé™æ—¥</label>
            <input type="date" id="editDeadline">
          </div>
          <div class="edit-field">
            <label>æ™‚åˆ»</label>
            <input type="time" id="editDeadlineTime">
          </div>
        </div>
        <div class="edit-row">
          <div class="edit-field">
            <label>å„ªå…ˆåº¦</label>
            <select id="editPriority">
              <option value="medium">ä¸­</option>
              <option value="high">é«˜</option>
              <option value="low">ä½</option>
            </select>
          </div>
          <div class="edit-field">
            <label>ç¹°ã‚Šè¿”ã—</label>
            <select id="editRepeat">
              <option value="none">ãªã—</option>
              <option value="daily">æ¯æ—¥</option>
              <option value="weekly">æ¯é€±</option>
              <option value="biweekly">éš”é€±</option>
              <option value="monthly">æ¯æœˆ</option>
            </select>
          </div>
        </div>
        <div class="edit-field">
          <label>ã‚¢ãƒ©ãƒ¼ãƒˆ</label>
          <select id="editAlert">
            <option value="none">ãªã—</option>
            <option value="1min">1åˆ†å‰</option>
            <option value="5min">5åˆ†å‰</option>
            <option value="same-day">å½“æ—¥</option>
            <option value="1day">1æ—¥å‰</option>
            <option value="3days">3æ—¥å‰</option>
            <option value="1week">1é€±é–“å‰</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal danger" onclick="deleteEditingTask()">å‰Šé™¤</button>
        <span style="flex:1"></span>
        <button class="btn-modal" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-modal primary" onclick="saveEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'task-manager-data';
    let tasks = [];
    let currentSource = 'mail';
    let editingTaskId = null;
    let editSource = 'mail';
    let draggedId = null;

    function loadTasks() {
      try { tasks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { tasks = []; }
    }
    function saveTasks() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }

    // ---- DateTime ----
    function getDeadlineDate(task) {
      if (!task.deadline) return null;
      return task.deadlineTime
        ? new Date(`${task.deadline}T${task.deadlineTime}:00`)
        : new Date(`${task.deadline}T23:59:59`);
    }
    function getMinutesUntil(task) {
      const dt = getDeadlineDate(task);
      return dt ? Math.floor((dt - new Date()) / 60000) : null;
    }
    function getDaysUntil(task) {
      if (!task.deadline) return null;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      return Math.floor((new Date(task.deadline + 'T00:00:00') - today) / 86400000);
    }

    // ---- CRUD ----
    function addTask() {
      const input = document.getElementById('taskInput');
      const title = input.value.trim();
      if (!title) return;
      const task = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 7),
        title,
        source: currentSource,
        deadline: document.getElementById('deadlineInput').value || null,
        deadlineTime: document.getElementById('deadlineTimeInput').value || null,
        priority: document.getElementById('priorityInput').value,
        repeat: document.getElementById('repeatInput').value,
        alertBefore: document.getElementById('alertInput').value,
        completed: false,
        createdAt: new Date().toISOString(),
        notified: false, alertNotified: false
      };
      tasks.unshift(task);
      saveTasks(); renderTasks(); updateAlertBanner();
      input.value = ''; input.focus();
    }

    function toggleTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.completed = !task.completed;
      if (task.completed && task.repeat !== 'none' && task.deadline) {
        const nextDeadline = calcNextDeadline(task.deadline, task.repeat);
        const next = { ...task, id: Date.now().toString(36) + Math.random().toString(36).slice(2, 7),
          deadline: nextDeadline, completed: false, createdAt: new Date().toISOString(), notified: false, alertNotified: false };
        tasks.unshift(next);
        showToast('ğŸ”„ æ¬¡å›ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ', `${task.title} â€” æœŸé™: ${formatDateTime(nextDeadline, task.deadlineTime)}`, 'warning');
      }
      saveTasks(); renderTasks(); updateAlertBanner();
    }

    function deleteTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      saveTasks(); renderTasks(); updateAlertBanner();
    }

    // ---- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ----
    function openEditModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      editingTaskId = id;
      document.getElementById('editTitle').value = task.title;
      setEditSource(task.source);
      document.getElementById('editDeadline').value = task.deadline || '';
      document.getElementById('editDeadlineTime').value = task.deadlineTime || '';
      document.getElementById('editPriority').value = task.priority;
      document.getElementById('editRepeat').value = task.repeat || 'none';
      document.getElementById('editAlert').value = task.alertBefore || 'none';
      document.getElementById('editModal').classList.add('active');
      document.getElementById('editTitle').focus();
    }

    function setEditSource(source) {
      editSource = source;
      document.querySelectorAll('#editSourceButtons .source-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.source === source);
      });
    }

    function saveEdit() {
      const task = tasks.find(t => t.id === editingTaskId);
      if (!task) return;
      const newTitle = document.getElementById('editTitle').value.trim();
      if (!newTitle) return;
      const oldDeadline = task.deadline;
      const oldTime = task.deadlineTime;
      const oldAlert = task.alertBefore;
      task.title = newTitle;
      task.source = editSource;
      task.deadline = document.getElementById('editDeadline').value || null;
      task.deadlineTime = document.getElementById('editDeadlineTime').value || null;
      task.priority = document.getElementById('editPriority').value;
      task.repeat = document.getElementById('editRepeat').value;
      task.alertBefore = document.getElementById('editAlert').value;
      // æœŸé™ã‚„ã‚¢ãƒ©ãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (task.deadline !== oldDeadline || task.deadlineTime !== oldTime) { task.notified = false; }
      if (task.alertBefore !== oldAlert || task.deadline !== oldDeadline || task.deadlineTime !== oldTime) { task.alertNotified = false; }
      saveTasks(); renderTasks(); updateAlertBanner();
      closeEditModal();
    }

    function deleteEditingTask() {
      if (editingTaskId && confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        deleteTask(editingTaskId);
        closeEditModal();
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingTaskId = null;
    }

    // ---- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ----
    function onDragStart(e, id) {
      draggedId = id;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    function onDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      draggedId = null;
    }
    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const card = e.target.closest('.task-card');
      if (card && card.dataset.id !== draggedId) {
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        card.classList.add('drag-over');
      }
    }
    function onDrop(e, targetId) {
      e.preventDefault();
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      if (!draggedId || draggedId === targetId) return;
      const fromIdx = tasks.findIndex(t => t.id === draggedId);
      const toIdx = tasks.findIndex(t => t.id === targetId);
      if (fromIdx === -1 || toIdx === -1) return;
      const [moved] = tasks.splice(fromIdx, 1);
      tasks.splice(toIdx, 0, moved);
      saveTasks(); renderTasks();
      // æ‰‹å‹•ä¸¦ã³æ›¿ãˆã«åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('sortBy').value = 'manual';
    }

    // ---- ç¹°ã‚Šè¿”ã— ----
    function calcNextDeadline(d, r) {
      const dt = new Date(d + 'T00:00:00');
      if (r === 'daily') dt.setDate(dt.getDate() + 1);
      else if (r === 'weekly') dt.setDate(dt.getDate() + 7);
      else if (r === 'biweekly') dt.setDate(dt.getDate() + 14);
      else if (r === 'monthly') dt.setMonth(dt.getMonth() + 1);
      return dt.toISOString().slice(0, 10);
    }
    function getRepeatLabel(r) { return { daily: 'æ¯æ—¥', weekly: 'æ¯é€±', biweekly: 'éš”é€±', monthly: 'æ¯æœˆ' }[r] || ''; }
    function getAlertLabel(a) { return { '1min': '1åˆ†å‰', '5min': '5åˆ†å‰', 'same-day': 'å½“æ—¥', '1day': '1æ—¥å‰', '3days': '3æ—¥å‰', '1week': '1é€±é–“å‰' }[a] || ''; }

    // ---- ã‚½ãƒ¼ã‚¹ ----
    function setSource(s) {
      currentSource = s;
      document.querySelectorAll('.input-section .source-btn').forEach(b => b.classList.toggle('active', b.dataset.source === s));
    }

    // ---- è¡¨ç¤º ----
    function getDeadlineStatus(task) {
      if (!task.deadline) return '';
      const mins = getMinutesUntil(task), days = getDaysUntil(task);
      if (mins !== null && mins < 0) return 'overdue';
      if (task.deadlineTime && mins !== null && mins <= 5) return 'due-minutes';
      if (days === 0) return 'due-today';
      if (days > 0 && days <= 3) return 'due-soon';
      if (days < 0) return 'overdue';
      return '';
    }
    function formatDate(d) { if (!d) return ''; const dt = new Date(d + 'T00:00:00'); return `${dt.getMonth() + 1}/${dt.getDate()}`; }
    function formatTime(t) { return t ? t.slice(0, 5) : ''; }
    function formatDateTime(d, t) { let s = formatDate(d); if (t) s += ' ' + formatTime(t); return s; }
    function getDeadlineSuffix(task) {
      const st = getDeadlineStatus(task), mins = getMinutesUntil(task), days = getDaysUntil(task);
      if (st === 'overdue') {
        if (task.deadlineTime && mins !== null) { const a = Math.abs(mins); return a < 60 ? ` (${a}åˆ†è¶…é)` : a < 1440 ? ` (${Math.floor(a/60)}æ™‚é–“è¶…é)` : ` (${Math.abs(days)}æ—¥è¶…é)`; }
        return ` (${Math.abs(days)}æ—¥è¶…é)`;
      }
      if (st === 'due-minutes') return mins <= 0 ? ' (ã¾ã‚‚ãªã)' : ` (ã‚ã¨${mins}åˆ†)`;
      if (st === 'due-today') {
        if (task.deadlineTime && mins !== null) return mins < 60 ? ` (ã‚ã¨${mins}åˆ†)` : ` (ã‚ã¨${Math.floor(mins/60)}æ™‚é–“)`;
        return ' (ä»Šæ—¥)';
      }
      if (st === 'due-soon') return ` (ã‚ã¨${days}æ—¥)`;
      return '';
    }
    function getSourceLabel(s) { return { mail: 'ãƒ¡ãƒ¼ãƒ«', slack: 'Slack', other: 'ãã®ä»–' }[s] || s; }
    function getPriorityLabel(p) { return { high: 'é«˜', medium: 'ä¸­', low: 'ä½' }[p] || p; }

    // ---- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ ----
    function getFilteredAndSorted() {
      const fs = document.getElementById('filterSource').value;
      const fst = document.getElementById('filterStatus').value;
      const sb = document.getElementById('sortBy').value;
      let f = tasks.filter(t => {
        if (fs !== 'all' && t.source !== fs) return false;
        if (fst === 'active' && t.completed) return false;
        if (fst === 'completed' && !t.completed) return false;
        return true;
      });
      if (sb === 'manual') return f; // æ‰‹å‹•é †ã¯tasksé…åˆ—ã®é †åºã‚’ãã®ã¾ã¾ä½¿ã†
      const po = { high: 0, medium: 1, low: 2 };
      f.sort((a, b) => {
        if (sb === 'deadline') { const da = getDeadlineDate(a), db = getDeadlineDate(b); if (!da && !db) return 0; if (!da) return 1; if (!db) return -1; return da - db; }
        if (sb === 'priority') return (po[a.priority] ?? 1) - (po[b.priority] ?? 1);
        return new Date(b.createdAt) - new Date(a.createdAt);
      });
      return f;
    }

    // ---- æç”» ----
    function renderTasks() {
      const list = document.getElementById('taskList');
      const filtered = getFilteredAndSorted();
      const isManual = document.getElementById('sortBy').value === 'manual';
      document.getElementById('taskCount').textContent = `æœªå®Œäº†: ${tasks.filter(t => !t.completed).length}ä»¶`;
      if (filtered.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><p>${tasks.length === 0 ? 'ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†' : 'è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“'}</p></div>`;
        return;
      }
      list.innerHTML = filtered.map(task => {
        const st = getDeadlineStatus(task);
        const cls = ['task-card', task.completed ? 'completed' : '', !task.completed && st ? st : ''].filter(Boolean).join(' ');
        const rep = task.repeat && task.repeat !== 'none' ? `<span class="tag-repeat">ğŸ”„ ${getRepeatLabel(task.repeat)}</span>` : '';
        const alt = task.alertBefore && task.alertBefore !== 'none' ? `<span class="tag-alert-time">ğŸ”” ${getAlertLabel(task.alertBefore)}</span>` : '';
        let dl = '';
        if (task.deadline) {
          const suf = getDeadlineSuffix(task), tm = task.deadlineTime ? ' ' + formatTime(task.deadlineTime) : '';
          dl = `<span class="tag-deadline ${st}">ğŸ“… ${formatDate(task.deadline)}${tm}${suf}</span>`;
        }
        const dragAttrs = isManual
          ? `draggable="true" ondragstart="onDragStart(event,'${task.id}')" ondragend="onDragEnd(event)" ondragover="onDragOver(event)" ondrop="onDrop(event,'${task.id}')"`
          : '';
        const dragHandle = isManual ? '<div class="drag-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ">â ¿</div>' : '';
        return `
          <div class="${cls}" data-id="${task.id}" ${dragAttrs}>
            ${dragHandle}
            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}')"></div>
            <div class="task-body" onclick="openEditModal('${task.id}')">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-meta">
                <span class="tag tag-${task.source}">${getSourceLabel(task.source)}</span>
                ${dl}
                <span class="tag-priority ${task.priority}">${getPriorityLabel(task.priority)}</span>
                ${rep} ${alt}
              </div>
            </div>
            <div class="task-actions">
              <button class="btn-task-action" onclick="openEditModal('${task.id}')" title="ç·¨é›†">âœ</button>
              <button class="btn-task-action delete" onclick="deleteTask('${task.id}')" title="å‰Šé™¤">âœ•</button>
            </div>
          </div>`;
      }).join('');
    }

    function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    // ---- ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ ----
    function updateAlertBanner() {
      const banner = document.getElementById('alertBanner');
      const urgent = tasks.filter(t => {
        if (t.completed || !t.deadline) return false;
        const m = getMinutesUntil(t), d = getDaysUntil(t);
        return (m !== null && m <= 5 && t.deadlineTime) || (d !== null && d <= 3);
      });
      if (!urgent.length) { banner.classList.remove('show', 'has-overdue'); return; }
      const overdue = urgent.filter(t => getMinutesUntil(t) < 0);
      const dueMin = urgent.filter(t => { const m = getMinutesUntil(t); return m >= 0 && m <= 5 && t.deadlineTime; });
      const dueToday = urgent.filter(t => { const m = getMinutesUntil(t), d = getDaysUntil(t); if (t.deadlineTime && m <= 5) return false; if (m < 0) return false; return d === 0; });
      const dueSoon = urgent.filter(t => { const d = getDaysUntil(t), m = getMinutesUntil(t); return m >= 0 && d > 0 && d <= 3; });
      let h = '<div class="alert-banner-title">âš ï¸ å¯¾å¿œãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯</div><ul class="alert-banner-list">';
      overdue.forEach(t => { const m = Math.abs(getMinutesUntil(t)); const l = m < 60 ? `${m}åˆ†è¶…é` : m < 1440 ? `${Math.floor(m/60)}æ™‚é–“è¶…é` : `${Math.abs(getDaysUntil(t))}æ—¥è¶…é`; h += `<li><span class="alert-badge">${l}</span> ${escapeHtml(t.title)}</li>`; });
      dueMin.forEach(t => { const m = getMinutesUntil(t); h += `<li><span class="alert-badge">${m <= 0 ? 'ã¾ã‚‚ãªã' : `ã‚ã¨${m}åˆ†`}</span> ${escapeHtml(t.title)}</li>`; });
      dueToday.forEach(t => { const m = getMinutesUntil(t); const l = t.deadlineTime && m > 0 ? (m < 60 ? `ã‚ã¨${m}åˆ†` : `ã‚ã¨${Math.floor(m/60)}æ™‚é–“`) : 'ä»Šæ—¥'; h += `<li><span class="alert-badge warning">${l}</span> ${escapeHtml(t.title)}</li>`; });
      dueSoon.forEach(t => { h += `<li><span class="alert-badge warning">ã‚ã¨${getDaysUntil(t)}æ—¥</span> ${escapeHtml(t.title)}</li>`; });
      h += '</ul>';
      banner.innerHTML = h;
      banner.classList.add('show');
      banner.classList.toggle('has-overdue', overdue.length > 0 || dueMin.length > 0);
    }

    function scrollToUrgent() {
      const el = document.querySelector('.task-card.overdue, .task-card.due-minutes, .task-card.due-today, .task-card.due-soon');
      if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.outline = '2px solid var(--danger)'; setTimeout(() => el.style.outline = '', 2000); }
    }

    // ---- ãƒˆãƒ¼ã‚¹ãƒˆ ----
    function showToast(title, body, type = 'danger') {
      const c = document.getElementById('toastContainer'), t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="toast-title">${escapeHtml(title)}</div><div class="toast-body">${escapeHtml(body)}</div>`;
      t.onclick = () => { t.style.animation = 'toastOut 0.3s forwards'; setTimeout(() => t.remove(), 300); };
      c.appendChild(t); playAlertSound();
      setTimeout(() => { if (t.parentNode) { t.style.animation = 'toastOut 0.3s forwards'; setTimeout(() => t.remove(), 300); } }, 8000);
    }

    function playAlertSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        [0, 0.2].forEach(d => { const o = ctx.createOscillator(), g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value = 800; o.type = 'sine'; g.gain.value = 0.15; g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + d + 0.15); o.start(ctx.currentTime + d); o.stop(ctx.currentTime + d + 0.15); });
      } catch {}
    }

    // ---- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ ----
    function requestNotification() {
      if (!('Notification' in window)) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
      Notification.requestPermission().then(p => { if (p === 'granted') document.getElementById('notificationBar').classList.remove('show'); });
    }
    function isMinuteBasedAlert(a) { return a === '1min' || a === '5min'; }
    function getAlertMinsBefore(a) { return { '1min': 1, '5min': 5 }[a] ?? 0; }
    function getAlertDaysBefore(a) { return { 'same-day': 0, '1day': 1, '3days': 3, '1week': 7 }[a] ?? null; }

    function checkReminders() {
      let changed = false;
      tasks.forEach(task => {
        if (task.completed || !task.deadline) return;
        const mins = getMinutesUntil(task), days = getDaysUntil(task);
        if (!task.notified && mins !== null && mins <= 0) {
          const am = Math.abs(mins);
          let label;
          if (task.deadlineTime) { label = am === 0 ? 'â° æœŸé™ã§ã™' : am < 60 ? `âš ï¸ ${am}åˆ†è¶…é` : `âš ï¸ ${Math.floor(am/60)}æ™‚é–“è¶…é`; }
          else { label = days < 0 ? `âš ï¸ ${Math.abs(days)}æ—¥è¶…é` : 'â° ä»Šæ—¥ãŒæœŸé™'; }
          sendNotif(`${label}: ${task.title}`, `ã‚½ãƒ¼ã‚¹: ${getSourceLabel(task.source)}`);
          showToast(label, task.title);
          task.notified = true; changed = true;
        }
        if (!task.alertNotified && task.alertBefore && task.alertBefore !== 'none') {
          let fire = false, msg = '';
          if (isMinuteBasedAlert(task.alertBefore)) {
            if (task.deadlineTime && mins !== null && mins <= getAlertMinsBefore(task.alertBefore) && mins >= 0) { fire = true; msg = mins === 0 ? 'æœŸé™ã§ã™' : `ã‚ã¨${mins}åˆ†ã§æœŸé™`; }
          } else {
            const ad = getAlertDaysBefore(task.alertBefore);
            if (ad !== null && days <= ad && days >= 0) {
              fire = true;
              if (days === 0) { msg = task.deadlineTime && mins > 0 ? (mins < 60 ? `ã‚ã¨${mins}åˆ†ã§æœŸé™` : `ã‚ã¨${Math.floor(mins/60)}æ™‚é–“ã§æœŸé™`) : 'ä»Šæ—¥ãŒæœŸé™ã§ã™'; }
              else { msg = `ã‚ã¨${days}æ—¥ã§æœŸé™ã§ã™`; }
            }
          }
          if (fire) { sendNotif(`ğŸ”” ${msg}: ${task.title}`, `ã‚½ãƒ¼ã‚¹: ${getSourceLabel(task.source)}`); showToast(`ğŸ”” ${msg}`, task.title, 'warning'); task.alertNotified = true; changed = true; }
        }
      });
      if (changed) saveTasks();
      renderTasks(); updateAlertBanner();
    }

    function sendNotif(title, body) {
      if (!('Notification' in window) || Notification.permission !== 'granted') return;
      new Notification(title, { body, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ“‹</text></svg>' });
    }

    function initNotificationBar() { if ('Notification' in window && Notification.permission === 'default') document.getElementById('notificationBar').classList.add('show'); }

    // ---- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ----
    function exportTasks() {
      const b = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(b);
      a.download = `tasks-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(a.href);
    }
    function showImportModal() { document.getElementById('importModal').classList.add('active'); }
    function closeImportModal() { document.getElementById('importModal').classList.remove('active'); document.getElementById('importFile').value = ''; }
    function importTasks() {
      const f = document.getElementById('importFile').files[0];
      if (!f) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      const r = new FileReader();
      r.onload = e => { try { const d = JSON.parse(e.target.result); if (!Array.isArray(d)) throw 0; tasks = d; saveTasks(); renderTasks(); updateAlertBanner(); closeImportModal(); } catch { alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™'); } };
      r.readAsText(f);
    }

    // ---- ã‚¤ãƒ™ãƒ³ãƒˆ ----
    document.getElementById('taskInput').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addTask(); } });
    document.getElementById('editTitle').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); saveEdit(); } });
    document.getElementById('importModal').addEventListener('click', function(e) { if (e.target === this) closeImportModal(); });
    document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) closeEditModal(); });

    // ---- åˆæœŸåŒ– ----
    loadTasks(); renderTasks(); updateAlertBanner(); initNotificationBar();
    checkReminders(); setInterval(checkReminders, 15000);
  </script>
</body>
</html>
